<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D N-Back Training</title>
    <style>
        body { 
            margin: 0; 
            background-color: #1a1a1a;
            font-family: Arial, sans-serif;
        }
        canvas { 
            display: block; 
            touch-action: none;
        }
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
        }
        #matchButton {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #nback-display {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            z-index: 1000;
        }
        #error-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            z-index: 1001;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="nback-display">N = 1</div>
    <div id="controls">
        <button id="matchButton" onclick="checkAnswer()">Match?</button>
    </div>
    <div id="error-display"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.159.0/three.min.js"></script>
    <script>
        // Previous configuration and variables remain the same
        const CONFIG = {
            rotationSpeed: 0.01,
            cubeDisplayTime: 1000,
            intervalTime: 3000,
            feedbackTime: 500,
            cubeColor: 0x7fb3d5,
            nBack: 1,
            lineWidth: 2,
            axesOffset: 1.5
        };

        let scene, camera, renderer, grid, currentCube;
        let positionHistory = [];
        let lastTime = 0;
        const gridSize = 2;
        const spacing = 1;

        function showError(message) {
            const errorDisplay = document.getElementById('error-display');
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
        }

        function init() {
            try {
                // Check WebGL support
                if (!THREE.WEBGL.isWebGLAvailable()) {
                    throw new Error('WebGL is not supported in your browser');
                }

                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1a1a1a);
                
                // Setup camera with explicit values
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 2, 5);
                camera.lookAt(0, 0, 0);

                // Create renderer with explicit error handling
                try {
                    renderer = new THREE.WebGLRenderer({ 
                        antialias: true,
                        alpha: true,
                        powerPreference: "high-performance"
                    });
                } catch (e) {
                    throw new Error('Failed to create WebGL renderer: ' + e.message);
                }

                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                
                const container = document.getElementById('game-container');
                container.innerHTML = ''; // Clear any existing content
                container.appendChild(renderer.domElement);

                // Add lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);

                createGrid();
                
                // Start the animation loop
                lastTime = performance.now();
                animate();

                // Start the game loop
                generateNewPosition();
                setInterval(generateNewPosition, CONFIG.intervalTime);

                // Handle window resize
                window.addEventListener('resize', onWindowResize, false);

                // Add debug output
                console.log('Scene initialized successfully');
                console.log('Camera position:', camera.position);
                console.log('Renderer:', renderer);
                console.log('Scene children:', scene.children);

            } catch (error) {
                showError('Initialization error: ' + error.message);
                console.error('Initialization error:', error);
            }
        }

        // Rest of the functions remain the same...
        
        function animate(time) {
            try {
                requestAnimationFrame(animate);
                
                const delta = time - lastTime;
                lastTime = time;
                
                if (grid) {
                    grid.rotation.y += CONFIG.rotationSpeed * (delta / 16.67);
                }
                
                renderer.render(scene, camera);
            } catch (error) {
                showError('Animation error: ' + error.message);
                console.error('Animation error:', error);
            }
        }

        // Initialize on both DOMContentLoaded and load events
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('load', init);
    </script>
</body>
</html>