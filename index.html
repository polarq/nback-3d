<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D N-Back Training</title>
    <style>
        /* Previous styles remain the same */
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="nback-display">N = 1</div>
    <div id="controls">
        <button id="matchButton" onclick="checkAnswer()">Match?</button>
    </div>
    <div id="error-display"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.159.0/three.min.js"></script>
    <script>
        // Check WebGL support
        function isWebGLAvailable() {
            try {
                const canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext && 
                    (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
            } catch(e) {
                return false;
            }
        }

        const CONFIG = {
            rotationSpeed: 0.01,
            cubeDisplayTime: 1000,
            intervalTime: 3000,
            feedbackTime: 500,
            cubeColor: 0x7fb3d5,
            nBack: 1,
            lineWidth: 2,
            axesOffset: 1.5
        };

        let scene, camera, renderer, grid, currentCube;
        let positionHistory = [];
        let lastTime = 0;
        const gridSize = 2;
        const spacing = 1;

        function showError(message) {
            const errorDisplay = document.getElementById('error-display');
            errorDisplay.textContent = message;
            errorDisplay.style.display = 'block';
        }

        function init() {
            try {
                // Check WebGL support first
                if (!isWebGLAvailable()) {
                    throw new Error('WebGL is not supported in your browser');
                }

                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1a1a1a);
                
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 2, 5);
                camera.lookAt(0, 0, 0);

                try {
                    renderer = new THREE.WebGLRenderer({ 
                        antialias: true,
                        alpha: true,
                        powerPreference: "high-performance"
                    });
                } catch (e) {
                    throw new Error('Failed to create WebGL renderer: ' + e.message);
                }

                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                
                const container = document.getElementById('game-container');
                container.innerHTML = '';
                container.appendChild(renderer.domElement);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);

                createGrid();
                
                lastTime = performance.now();
                animate();

                generateNewPosition();
                setInterval(generateNewPosition, CONFIG.intervalTime);

                window.addEventListener('resize', onWindowResize, false);

            } catch (error) {
                showError('Initialization error: ' + error.message);
                console.error('Initialization error:', error);
            }
        }

        // Rest of the functions (createGrid, generateNewPosition, etc.) remain exactly the same...

        function animate(time) {
            try {
                requestAnimationFrame(animate);
                
                const delta = time - lastTime;
                lastTime = time;
                
                if (grid) {
                    grid.rotation.y += CONFIG.rotationSpeed * (delta / 16.67);
                }
                
                renderer.render(scene, camera);
            } catch (error) {
                showError('Animation error: ' + error.message);
                console.error('Animation error:', error);
            }
        }

        // Rest of the code remains the same...

        // Initialize only once when the page is loaded
        window.addEventListener('load', init);
    </script>
</body>
</html>